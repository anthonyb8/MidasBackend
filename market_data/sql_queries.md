### Aggregate BarData
WITH InitialValues AS (
    SELECT
        mdb.symbol_id,
        s.ticker,
        date(mdb.timestamp / 1000000000, 'unixepoch') AS date,
        mdb.open,
        mdb.high,
        mdb.low,
        mdb.close,
        mdb.volume,
        ROW_NUMBER() OVER (PARTITION BY mdb.symbol_id, date(mdb.timestamp / 1000000000, 'unixepoch') ORDER BY mdb.timestamp) AS row_num_open,
        ROW_NUMBER() OVER (PARTITION BY mdb.symbol_id, date(mdb.timestamp / 1000000000, 'unixepoch') ORDER BY mdb.timestamp DESC) AS row_num_close
    FROM
        market_data_bardata mdb
    JOIN
        symbols_symbol s ON mdb.symbol_id = s.id
    WHERE
        s.ticker = 'HE.n.0' AND
        mdb.timestamp BETWEEN 1710806400000000000 AND 1710946800000000000
),
DailyData AS (
    SELECT
        symbol_id,
        ticker,
        date,
        (SELECT open FROM InitialValues iv WHERE iv.symbol_id = InitialValues.symbol_id AND iv.date = InitialValues.date AND iv.row_num_open = 1) AS open,
        MAX(high) AS high,
        MIN(low) AS low,
        (SELECT close FROM InitialValues iv WHERE iv.symbol_id = InitialValues.symbol_id AND iv.date = InitialValues.date AND iv.row_num_close = 1) AS close,
        SUM(volume) AS volume
    FROM
        InitialValues
    GROUP BY
        symbol_id,
        ticker,
        date
)
SELECT
    symbol_id,
    ticker,
    date,
    open,
    high,
    low,
    close,
    volume
FROM
    DailyData
ORDER BY
    date;


### Select All By Ticker
SELECT
    mdb.symbol_id,
    s.ticker,
    mdb.timestamp,
    mdb.open,
    mdb.high,
    mdb.low,
    mdb.close,
    mdb.volume
FROM
    market_data_bardata mdb
JOIN
    symbols_symbol s ON mdb.symbol_id = s.id
WHERE
    s.ticker = 'HE.n.0'
ORDER BY
    mdb.timestamp;



# Create Mock data
INSERT INTO market_data_bardata (open, close, high, low, volume, symbol_id, timestamp) VALUES
-- Day 1
(100, 105, 106, 99, 1000, 15, 1710806400000000000), -- 2024-03-01 00:00:00
(105, 110, 112, 104, 1500, 15, 1710810000000000000), -- 2024-03-01 01:00:00
(110, 108, 111, 107, 1300, 15, 1710813600000000000), -- 2024-03-01 02:00:00
(108, 107, 109, 106, 1200, 15, 1710817200000000000), -- 2024-03-01 03:00:00
(107, 110, 112, 106, 1400, 15, 1710820800000000000), -- 2024-03-01 04:00:00
(110, 115, 116, 109, 1600, 15, 1710824400000000000), -- 2024-03-01 05:00:00
(115, 113, 117, 112, 1100, 15, 1710828000000000000), -- 2024-03-01 06:00:00
(113, 112, 114, 111, 900, 15, 1710831600000000000), -- 2024-03-01 07:00:00
(112, 111, 113, 110, 800, 15, 1710835200000000000), -- 2024-03-01 08:00:00
(111, 115, 116, 110, 1700, 15, 1710838800000000000), -- 2024-03-01 09:00:00
(115, 118, 119, 114, 1800, 15, 1710842400000000000), -- 2024-03-01 10:00:00
(118, 117, 119, 116, 1600, 15, 1710846000000000000), -- 2024-03-01 11:00:00
(117, 119, 120, 116, 1900, 15, 1710849600000000000), -- 2024-03-01 12:00:00
(119, 118, 121, 117, 1400, 15, 1710853200000000000), -- 2024-03-01 13:00:00
(118, 120, 121, 117, 1500, 15, 1710856800000000000), -- 2024-03-01 14:00:00
(120, 122, 123, 119, 2000, 15, 1710860400000000000), -- 2024-03-01 15:00:00
(122, 121, 124, 120, 1300, 15, 1710864000000000000), -- 2024-03-01 16:00:00
(121, 120, 123, 119, 1100, 15, 1710867600000000000), -- 2024-03-01 17:00:00
(120, 118, 121, 117, 1000, 15, 1710871200000000000), -- 2024-03-01 18:00:00
(118, 119, 120, 117, 900, 15, 1710874800000000000), -- 2024-03-01 19:00:00
(119, 118, 120, 117, 800, 15, 1710878400000000000), -- 2024-03-01 20:00:00
(118, 117, 119, 116, 700, 15, 1710882000000000000), -- 2024-03-01 21:00:00
(117, 116, 118, 115, 600, 15, 1710885600000000000), -- 2024-03-01 22:00:00
(116, 115, 117, 114, 500, 15, 1710889200000000000), -- 2024-03-01 23:00:00

-- Day 2
(115, 117, 118, 114, 1500, 15, 1710892800000000000), -- 2024-03-02 00:00:00
(117, 118, 119, 116, 1400, 15, 1710896400000000000), -- 2024-03-02 01:00:00
(118, 119, 120, 117, 1300, 15, 1710900000000000000), -- 2024-03-02 02:00:00
(119, 120, 121, 118, 1200, 15, 1710903600000000000), -- 2024-03-02 03:00:00
(120, 121, 122, 119, 1100, 15, 1710907200000000000), -- 2024-03-02 04:00:00
(121, 122, 123, 120, 1000, 15, 1710910800000000000), -- 2024-03-02 05:00:00
(122, 123, 124, 121, 900, 15, 1710914400000000000), -- 2024-03-02 06:00:00
(123, 124, 125, 122, 800, 15, 1710918000000000000), -- 2024-03-02 07:00:00
(124, 125, 126, 123, 700, 15, 1710921600000000000), -- 2024-03-02 08:00:00
(125, 126, 127, 124, 600, 15, 1710925200000000000), -- 2024-03-02 09:00:00
(126, 127, 128, 125, 500, 15, 1710928800000000000), -- 2024-03-02 10:00:00
(127, 128, 129, 126, 400, 15, 1710932400000000000), -- 2024-03-02 11:00:00
(128, 129, 130, 127, 300, 15, 1710936000000000000), -- 2024-03-02 12:00:00
(129, 130, 131, 128, 200, 15, 1710939600000000000), -- 2024-03-02 13:00:00
(130, 131, 132, 129, 100, 15, 1710943200000000000), -- 2024-03-02 14:00:00
(131, 132, 133, 130, 50, 15, 1710946800000000000); -- 2024-03-02 15:00:00


